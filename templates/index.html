<html>
  <head>
    <link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
  </head>
  <body>
    <form action="/donate" method="post">
    {% ifequal subject.status "send" %}
      <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
      <script>
      function check(divId)
      {
          if($(divId).val().search(/^[0-9]+$/) != 0)
          {
            $(divId).val("0");
          }
          var total = 0;
	  $(divId).val(parseInt($(divId).val(), 10).toString());
          {% for friend in friends %}
          total += parseInt($("#{{ friend.name }}").val(), 10);
          {% endfor %} 
          if(total > parseInt("{{ subject.money }}", 10))
          {
            $(divId).val("0");
            alert("Not Enough Tokens!!");
          }

      }
      function time_up()
      {
        var paras = new Array();
        {% for friend in friends %}
        paras["{{ friend.name }}"] = $("#{{ friend.name }}").val(); 
        {% endfor %}
        post_to_url("/donate", paras, "post");
      }
 
      function post_to_url(path, params, method) 
      {
        method = method || "post"; // Set method to post by default, if not specified.

        var form = document.createElement("form");
        form.setAttribute("method", method);
        form.setAttribute("action", path);

        for(var key in params) {
          var hiddenField = document.createElement("input");
          hiddenField.setAttribute("type", "hidden");
          hiddenField.setAttribute("name", key);
          hiddenField.setAttribute("value", params[key]);
          form.appendChild(hiddenField);
        }

        document.body.appendChild(form);    // Not entirely sure if this is necessary
        form.submit();
      }
      setTimeout("time_up()", 120000);
      
      </script>
      You are {{ subject.name }}.<br/>
      {% ifnotequal turn 1 %}
        You had donated {{ send }} tokens out and received {{ receive }} tokens from others.<br/>
      {% endifnotequal %}
      Your current balance: {{ subject.money }} tokens.<br/>
      <br/>
      {% if showGlobal %}
        {% for s in globals %}
          {{ s.name }}’s balance: {{s.money}} tokens<br/>
        {% endfor %}<br/>
      {% endif %}<br/>
      Please indicate how much you would like to donate to each of the following:<br/><br/>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspYour donation:<br/>
      <br/>
      {% for friend in friends %}
        <div>{{ friend.name }}’s balance: {{friend.money}} tokens &nbsp &nbsp &nbsp &nbsp<input type="text" name="{{ friend.name }}" id="{{ friend.name }}" value="0" onblur=check("#{{ friend.name }}")></div>
      {% endfor %}<br/>
      <div><input type="submit" name="status" value="Send" id="send"></div>
    {% else %} {% ifequal subject.status "done" %}
      <script>
      setTimeout("window.location.reload()",1000)
      </script>
      <div>Thank you. Please wait and we will proceed once everyone is done with their part.</div>
    {% endifequal %}{% endifequal %}
    </form>
    <a href="{{ url }}">{{ url_linktext }}</a>
  </body>
</html>
